<!DOCTYPE html>
<html lang="en">
<div th:replace="~{app/header :: header}"></div>
<body>
<div class="loader-wrapper">
    <div class="loader">
        <div class="loader4">
        </div>
    </div>
</div>
<div class="tap-top">
    <i data-feather="chevrons-up">
    </i>
</div>
<div class="page-wrapper compact-wrapper" id="pageWrapper">
    <div class="page-header" bis_skin_checked="1">
        <div th:replace="~{app/nav :: nav}">
        </div>
    </div>
    <div class="page-body-wrapper">
        <div th:replace="~{admin/app/leftsider :: sider}">
        </div>
        <div class="page-body">
            <div class="container-fluid">
                <div class="page-title">
                    <div class="row">
                        <div class="col-6">
                            <h4>
                                Trang Ch·ªß
                            </h4>
                        </div>
                        <div class="col-6">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item active text-end" th:text="'S·ªë d∆∞: ' + ${money} + 'ƒë'">
                                    S·ªë D∆∞
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>


            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="list-product-header">
                                    <form class="d-flex align-items-end flex-wrap gap-3">
                                        <!-- üîç Input t√¨m ki·∫øm -->
                                        <div>
                                            <label for="search" class="form-label mb-1">T√¨m ki·∫øm</label>
                                            <input type="text"
                                                   class="form-control"
                                                   id="search"
                                                   name="search"
                                                   placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
                                        </div>
                                        <!-- üîΩ Select danh m·ª•c -->
                                        <div>
                                            <label for="title-filter" class="form-label mb-1">Ch·ªçn danh m·ª•c</label>
                                            <select class="form-select" id="title-filter" aria-label="Ch·ªçn danh m·ª•c">
                                                <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                                                <option th:each="item : ${danhmucspList}"
                                                        th:value="${item.title}"
                                                        th:text="${item.title}">
                                                </option>
                                            </select>
                                        </div>
                                        <!-- üîΩ Select tr·∫°ng th√°i -->
                                        <div>
                                            <label for="status-filter" class="form-label">L·ªçc theo tr·∫°ng th√°i:</label>
                                            <select class="form-select" id="status-filter">
                                                <option value="">T·∫•t c·∫£</option>
                                                <option value="hoatdong">Ho·∫°t ƒë·ªông</option>
                                                <option value="dunghoatdong">D·ª´ng ho·∫°t ƒë·ªông</option>
                                            </select>
                                        </div>
                                        <div>
                                            <button type="button"
                                                    class="btn btn-secondary"
                                                    id="btnReloadCategory">
                                                <i class="fa fa-rotate-right"></i> Reload
                                            </button>
                                        </div>

                                        <!-- ‚ûï N√∫t Add Category -->
                                        <div class="ms-auto">
                                            <label class="form-label mb-1 d-block invisible">Th√™m</label>
                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAddCategory">
                                                <i class="fa fa-plus"></i> Th√™m danh m·ª•c
                                            </button>
                                        </div>
                                    </form>
                                </div>



                                <div class="list-product list-category">
                                    <div class="datatable-wrapper datatable-loading no-footer sortable searchable fixed-columns">
                                        <div class="datatable-container">
                                            <table class="table datatable-table" id="category-table">
                                                <thead>
                                                <tr>
                                                    <th style="width: 4%; text-align: center;">
                                                        <div class="form-check">
                                                            <input class="form-check-input checkbox-primary" type="checkbox">
                                                        </div>
                                                    </th>
                                                    <th style="width: 20%; text-align: center;"> <span class="f-light f-w-600">Title</span> </th>
                                                    <th style="width: 20%; text-align: center;"> <span class="f-light f-w-600">TOSLU</span> </th>
                                                    <th style="width: 20%; text-align: center;"> <span class="f-light f-w-600">Image</span> </th>
                                                    <th style="width: 16%; text-align: center;"> <span class="f-light f-w-600">Status</span> </th>
                                                    <th style="width: 20%; text-align: center;"> <span class="f-light f-w-600">Action</span> </th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr th:each="danhmucsp : ${danhmucspList}"
                                                    th:attr="data-status=${danhmucsp.status}, data-title=${danhmucsp.title}">
                                                    <!-- Checkbox -->
                                                    <td>
                                                        <div class="form-check">
                                                            <input class="form-check-input checkbox-primary" type="checkbox">
                                                        </div>
                                                    </td>
                                                    <!-- Title -->
                                                    <td style="text-align: center;">
                                                        <span th:text="${danhmucsp.title}">T√™n danh m·ª•c</span>
                                                    </td>
                                                    <!-- TOSLU -->
                                                    <td style="text-align: center;">
                                                        <span th:text="${danhmucsp.toslu}">0</span>
                                                    </td>
                                                    <!-- Image -->
                                                    <td style="text-align: center;">
                                                        <img class="img-fluid rounded" th:src="@{${danhmucsp.img}}" alt="category image"  style="height: 75px;width: 75px;" />
                                                    </td>
                                                    <!-- Status -->
                                                    <td style="text-align: center;">
                                                   <span  th:classappend="${danhmucsp.status == 'hoatdong'} ?
                                                      'badge badge-light-success' : 'badge badge-light-danger'"
                                                          th:text="${danhmucsp.status == 'hoatdong'} ?
                                                      'Ho·∫°t ƒë·ªông' : 'D·ª´ng ho·∫°t ƒë·ªông'">
                                                   Tr·∫°ng th√°i
                                                   </span>
                                                    </td>
                                                    <!-- Actions -->
                                                    <td>
                                                        <div class="product-action d-flex gap-2 justify-content-center">
                                                            <!-- N√∫t S·ª≠a -->
                                                            <button type="button"
                                                                    th:attr="data-id=${danhmucsp.id}"
                                                                    class="btn btn-sm btn-outline-primary edit-category"
                                                                    title="S·ª≠a danh m·ª•c">
                                                                <i class="fa-solid fa-pen"></i>
                                                                <span style="margin-left: 5px">
                                                      Edit
                                                      </span>
                                                            </button>
                                                            <!-- N√∫t X√≥a -->
                                                            <button type="button"
                                                                    th:attr="data-id=${danhmucsp.id}"
                                                                    class="btn btn-sm btn-outline-danger delete-category"
                                                                    title="X√≥a danh m·ª•c">
                                                                <i class="fa-solid fa-trash"></i>
                                                                <span style="margin-left: 5px">
                                                      DELETE
                                                      </span>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>






                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Modal th√™m danh m·ª•c -->
            <div class="modal fade" id="modalAddCategory" tabindex="-1" aria-labelledby="modalAddCategoryLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <form id="formAddCategoryAjax">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalAddCategoryLabel">Th√™m danh m·ª•c</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Title -->
                                <div class="mb-3">
                                    <label for="input-title-modal" class="form-label">T√™n danh m·ª•c</label>
                                    <input type="text" class="form-control" name="title" id="input-title-modal" required>
                                </div>
                                <!-- TOSLU -->
                                <div class="mb-3">
                                    <label for="input-toslu-modal" class="form-label">TOSLU</label>
                                    <input type="text" class="form-control" name="toslu" id="input-toslu-modal" required>
                                </div>
                                <!-- ·∫¢nh upload + link -->
                                <div class="mb-3">
                                    <label for="img-upload" class="form-label">Ch·ªçn ·∫£nh</label>
                                    <input type="file" class="form-control" id="img-upload" accept="image/*" />
                                    <input type="hidden" name="img" id="img-path" />
                                    <img id="preview-img" src="#" class="mt-2 d-none" height="40" />
                                </div>
                                <!-- Tr·∫°ng th√°i -->
                                <div class="mb-3">
                                    <label for="select-status-modal" class="form-label">Tr·∫°ng th√°i</label>
                                    <select class="form-select" name="status" id="select-status-modal" required>
                                        <option disabled selected>Ch·ªçn tr·∫°ng th√°i</option>
                                        <option value="hoatdong">Ho·∫°t ƒë·ªông</option>
                                        <option value="dunghoatdong">D·ª´ng ho·∫°t ƒë·ªông</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" id="btnAddCategory">Th√™m</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Modal s·ª≠a danh m·ª•c -->
            <div class="modal fade" id="modalEditCategory" tabindex="-1" aria-labelledby="modalEditCategoryLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <form id="formEditCategoryAjax">
                            <input type="hidden" id="edit-id" />
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalEditCategoryLabel">S·ª≠a danh m·ª•c</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="edit-title" class="form-label">T√™n danh m·ª•c</label>
                                    <input type="text" class="form-control" id="edit-title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-toslu" class="form-label">TOSLU</label>
                                    <input type="text" class="form-control" id="edit-toslu" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-img-upload" class="form-label">Ch·ªçn ·∫£nh m·ªõi (n·∫øu c√≥)</label>
                                    <input type="file" class="form-control" id="edit-img-upload" accept="image/*" />
                                    <input type="hidden" id="edit-img-path" />
                                    <img id="edit-preview-img" src="#" class="mt-2 d-none" height="40" />
                                </div>
                                <div class="mb-3">
                                    <label for="edit-status" class="form-label">Tr·∫°ng th√°i</label>
                                    <select class="form-select" id="edit-status" required>
                                        <option value="hoatdong">Ho·∫°t ƒë·ªông</option>
                                        <option value="dunghoatdong">D·ª´ng ho·∫°t ƒë·ªông</option>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="btnUpdateCategory">C·∫≠p nh·∫≠t</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Th√¥ng b√°o (s·∫Ω d√πng alert JS n√™n ph·∫ßn n√†y kh√¥ng c·∫ßn) -->
            <!-- jQuery + SweetAlert2 -->
            <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <script>
                $("#btnReloadCategory").on("click", function () {
                    // Reset dropdown l·ªçc
                    $("#status-filter").val('');
                    $("#title-filter").val('');

                    // Reset √¥ t√¨m ki·∫øm
                    $("#search").val('');

                    // Hi·ªán l·∫°i t·∫•t c·∫£ c√°c d√≤ng
                    $("#category-table tbody tr").each(function () {
                        $(this).show();
                    });

                    // N·∫øu c√≥ d√πng DataTables ‚Üí reset search
                    if ($.fn.DataTable && $.fn.dataTable.isDataTable('#category-table')) {
                        $('#category-table').DataTable().search('').draw();
                    }
                });

                $("#btnAddCategory").on("click", function (event) {
                    event.preventDefault();
                    $('#btnAddCategory').html('<i class="fa fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...').prop('disabled', true);

                    const title = $("#input-title-modal").val().trim();
                    const toslu = $("#input-toslu-modal").val().trim();
                    const img = $("#img-path").val().trim();
                    const status = $("#select-status-modal").val();

                    if (!title || !toslu || !img || !status) {
                        Swal.fire({
                            title: "Thi·∫øu th√¥ng tin",
                            icon: "warning",
                            text: "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† upload ·∫£nh!",
                            customClass: {
                                confirmButton: "btn btn-warning"
                            }
                        });
                        $('#btnAddCategory').html('Th√™m').prop('disabled', false);
                        return;
                    }

                    const formData = {
                        title: title,
                        toslu: toslu,
                        img: img,
                        status: status
                    };

                    $.post("/admin/add", formData, function (data) {
                        if (data.status === 'success') {
                            Swal.fire({
                                title: "Th√†nh c√¥ng",
                                icon: "success",
                                text: data.msg,
                                customClass: {
                                    confirmButton: "btn btn-primary"
                                }
                            });
                            setTimeout(function () {
                                window.location.reload(); // Ho·∫∑c g·ªçi loadDanhMuc()
                            }, 1500);
                        } else {
                            Swal.fire({
                                title: "L·ªói",
                                icon: "error",
                                text: data.msg,
                                customClass: {
                                    confirmButton: "btn btn-primary"
                                }
                            });
                        }
                        $('#btnAddCategory').html('Th√™m').prop('disabled', false);
                    }, "json")
                        .fail(function () {
                            Swal.fire({
                                title: "L·ªói server",
                                icon: "error",
                                text: "Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu ƒë·∫øn m√°y ch·ªß.",
                                customClass: {
                                    confirmButton: "btn btn-danger"
                                }
                            });
                            $('#btnAddCategory').html('Th√™m').prop('disabled', false);
                        });
                });

                // Upload ·∫£nh
                $("#img-upload").on("change", function () {
                    const file = this.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append("file", file);

                    fetch("/admin/category/upload-img", {
                        method: "POST",
                        body: formData
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                $("#img-path").val(data.link);
                                $("#preview-img").attr("src", data.link).removeClass("d-none");
                            } else {
                                Swal.fire("Upload th·∫•t b·∫°i", data.msg, "error");
                            }
                        })
                        .catch((err) => {
                            console.error("L·ªói upload ·∫£nh:", err);
                            Swal.fire("L·ªói", "Kh√¥ng th·ªÉ upload ·∫£nh", "error");
                        });
                });

                document.getElementById('status-filter').addEventListener('change', function () {
                    const selectedStatus = this.value;
                    const rows = document.querySelectorAll('#category-table tbody tr');

                    rows.forEach(row => {
                        const rowStatus = row.getAttribute('data-status');
                        if (!selectedStatus || rowStatus === selectedStatus) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });

                document.getElementById('title-filter').addEventListener('change', function () {
                    const selectedTitle = this.value.trim().toLowerCase();
                    const rows = document.querySelectorAll('#category-table tbody tr');

                    rows.forEach(row => {
                        const rowTitle = row.getAttribute('data-title')?.toLowerCase();
                        if (!selectedTitle || rowTitle === selectedTitle) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
                document.getElementById('search').addEventListener('input', function () {
                    const keyword = this.value.trim().toLowerCase();
                    const rows = document.querySelectorAll('#category-table tbody tr');

                    rows.forEach(row => {
                        const title = row.getAttribute('data-title')?.toLowerCase();
                        if (!keyword || title.includes(keyword)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });

                $(document).on("click", ".delete-category", function () {
                    const id = $(this).data("id");

                    Swal.fire({
                        title: "B·∫°n c√≥ ch·∫Øc mu·ªën xo√° danh m·ª•c n√†y?",
                        text: "Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Xo√°",
                        cancelButtonText: "H·ªßy",
                        customClass: {
                            confirmButton: "btn btn-danger",
                            cancelButton: "btn btn-secondary"
                        },
                        buttonsStyling: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: "/admin/delete/" + id,
                                type: "DELETE",
                                success: function (data) {
                                    if (data.status === "success") {
                                        Swal.fire("ƒê√£ xo√°!", data.msg, "success");
                                        setTimeout(() => location.reload(), 1500);
                                    } else {
                                        Swal.fire("Th·∫•t b·∫°i", data.msg, "error");
                                    }
                                },
                                error: function () {
                                    Swal.fire("L·ªói", "Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi m√°y ch·ªß", "error");
                                }
                            });
                        }
                    });
                });

                document.addEventListener('DOMContentLoaded', function () {
                    const editButtons = document.querySelectorAll('.edit-category');

                    editButtons.forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            const row = btn.closest('tr');

                            // L·∫•y d·ªØ li·ªáu t·ª´ h√†ng t∆∞∆°ng ·ª©ng
                            const id = btn.getAttribute('data-id');
                            const title = row.querySelector('td:nth-child(2) span').innerText.trim();
                            const toslu = row.querySelector('td:nth-child(3) span').innerText.trim();
                            const imgSrc = row.querySelector('td:nth-child(4) img')?.getAttribute('src');
                            const statusText = row.querySelector('td:nth-child(5) span').innerText.trim().toLowerCase();

                            // G√°n v√†o form s·ª≠a
                            document.getElementById('edit-id').value = id;
                            document.getElementById('edit-title').value = title;
                            document.getElementById('edit-toslu').value = toslu;
                            document.getElementById('edit-preview-img').src = imgSrc;
                            document.getElementById('edit-status').value = (statusText === 'ho·∫°t ƒë·ªông') ? 'hoatdong' : 'dunghoatdong';

                            // Hi·ªán modal
                            new bootstrap.Modal(document.getElementById('modalEditCategory')).show();
                        });
                    });
                });

                // Click "C·∫≠p nh·∫≠t"
                $("#btnUpdateCategory").on("click", function (event) {
                    event.preventDefault();
                    $('#btnUpdateCategory').html('<i class="fa fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...').prop('disabled', true);

                    const id = $("#edit-id").val();
                    const title = $("#edit-title").val().trim();
                    const toslu = $("#edit-toslu").val().trim();
                    const img = $("#edit-img-path").val().trim();
                    const status = $("#edit-status").val();

                    if (!title || !toslu || !status) {
                        Swal.fire("Thi·∫øu d·ªØ li·ªáu", "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!", "warning");
                        $('#btnUpdateCategory').html('C·∫≠p nh·∫≠t').prop('disabled', false);
                        return;
                    }

                    const formData = {
                        title: title,
                        toslu: toslu,
                        img: img,
                        status: status
                    };

                    $.post("/admin/update/" + id, formData, function (data) {
                        if (data.status === 'success') {
                            Swal.fire("C·∫≠p nh·∫≠t th√†nh c√¥ng", data.msg, "success");
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            Swal.fire("Th·∫•t b·∫°i", data.msg, "error");
                        }
                        $('#btnUpdateCategory').html('C·∫≠p nh·∫≠t').prop('disabled', false);
                    }, "json").fail(() => {
                        Swal.fire("L·ªói server", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t", "error");
                        $('#btnUpdateCategory').html('C·∫≠p nh·∫≠t').prop('disabled', false);
                    });
                });

                // Upload ·∫£nh khi s·ª≠a
                $("#edit-img-upload").on("change", function () {
                    const file = this.files[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append("file", file);

                    fetch("/admin/category/upload-img", {
                        method: "POST",
                        body: formData
                    })
                        .then((res) => res.json())
                        .then((data) => {
                            if (data.status === "success") {
                                $("#edit-img-path").val(data.link);
                                $("#edit-preview-img").attr("src", data.link).removeClass("d-none");
                            } else {
                                Swal.fire("Upload th·∫•t b·∫°i", data.msg, "error");
                            }
                        })
                        .catch((err) => {
                            console.error("L·ªói upload ·∫£nh:", err);
                            Swal.fire("L·ªói", "Kh√¥ng th·ªÉ upload ·∫£nh", "error");
                        });
                });

                // H√†m m·ªü modal v√† g√°n d·ªØ li·ªáu
                function openEditModal(danhmuc) {
                    $("#edit-id").val(danhmuc.id);
                    $("#edit-title").val(danhmuc.title);
                    $("#edit-toslu").val(danhmuc.toslu);
                    $("#edit-img-path").val(danhmuc.img);
                    $("#edit-preview-img").attr("src", danhmuc.img).removeClass("d-none");
                    $("#edit-status").val(danhmuc.status);
                    $("#modalEditCategory").modal("show");
                }
            </script>
        </div>
        <div th:replace="~{app/footer :: footer}">
        </div>
    </div>
</div>
<div th:replace="~{app/script :: script}"></div>
</body>
</html>